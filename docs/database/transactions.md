# Транзакции в БД

>**Транзакция** — это логическая единица работы, состоящая из одного или нескольких SQL-запросов, которая либо выполняется целиком, либо не выполняется вовсе. 

### ACID

>Свойства ACID: атомарность(atomicity), согласованность(consistency), изолированность(isolation), долговечность(durability).

**ACID (Atomicity, Consistency, Isolation, Durability)** — это набор свойств, обеспечивающих надежность и целостность транзакций в базах данных. 
Эти свойства гарантируют, что операции в базе данных будут выполняться надежно и предсказуемо даже в случае сбоев или ошибок. 
Давайте рассмотрим каждое из свойств ACID более подробно:

* **Atomicity (Атомарность):**
    * Определение: Транзакция считается атомарной, если она выполняется целиком или не выполняется вообще.
    * Пример: Рассмотрим транзакцию, в которой средства переводятся с одного банковского счета на другой. Атомарность гарантирует, что либо деньги переведены полностью, либо операция не выполняется вовсе.
* **Consistency (Согласованность):**
    * Определение: Согласованность гарантирует, что база данных после успешного завершения транзакции находится в согласованном состоянии.
    * Пример: Если транзакция изменяет значения нескольких связанных записей, то после ее завершения все связанные данные должны находиться в согласованном состоянии.
* **Isolation (Изолированность):**
    * Определение: Изолированность гарантирует, что выполнение одной транзакции не влияет на выполнение других транзакций. Они выполняются параллельно, но так, чтобы результат был таким, как если бы они выполнялись последовательно.
    * Пример: Допустим, две транзакции одновременно обновляют одну и ту же запись. Изолированность гарантирует, что результат будет корректным, даже если эти транзакции выполняются одновременно.
* **Durability (Долговечность):**
    * Определение: Долговечность гарантирует, что результаты успешно завершенных транзакций будут сохранены и не будут потеряны после сбоев системы или перезапусков.
    * Пример: Если транзакция фиксируется, то изменения, внесенные этой транзакцией, должны сохраняться даже в случае отключения питания или других сбоев системы.
      ACID-свойства обеспечивают стабильность и целостность баз данных, делая их надежными для работы с критическими данными, такими как финансовая информация, личные записи и другие важные данные, где важна точность и надежность операций.

### Уровни изоляций транзакций

Уровень изоляции транзакций в базе данных определяет степень видимости изменений, внесенных одной транзакцией, для других транзакций. Различные уровни изоляции предоставляют разные гарантии по отношению к конкурентному доступу и предотвращению аномалий транзакций. В стандарте SQL определены четыре уровня изоляции:

* READ UNCOMMITTED (Чтение неподтвержденных данных):
  * Описание: Этот уровень изоляции позволяет транзакциям видеть изменения, внесенные другими транзакциями, даже если эти изменения еще не были подтверждены (зафиксированы).
  * Возможные аномалии: Грязное чтение, неповторяемое чтение, фантомное чтение.
  * Примечание: Этот уровень изоляции предоставляет самый высокий уровень параллелизма, но также может привести к серьезным аномалиям.
* READ COMMITTED (Чтение подтвержденных данных):
  * Описание: Транзакции видят только подтвержденные изменения. Гарантирует, что никакие грязные данные не будут прочитаны, но не предотвращает неповторяемое чтение или фантомные чтения.
  * Возможные аномалии: Неповторяемое чтение, фантомное чтение.
  * Примечание: Это уровень изоляции по умолчанию для большинства баз данных.
* REPEATABLE READ (Повторяемое чтение):
  * Описание: Гарантирует, что транзакции видят только те данные, которые были существующими на момент начала транзакции. Предотвращает грязное чтение и неповторяемое чтение.
  * Возможные аномалии: Фантомные чтения.
  * Примечание: Этот уровень изоляции обеспечивает более высокую степень надежности, но может уменьшить параллелизм.
* SERIALIZABLE (Сериализуемость):
  * Описание: Обеспечивает наивысший уровень изоляции. Предотвращает все аномалии транзакций, включая грязное чтение, неповторяемое чтение и фантомные чтения, за счет блокировки ресурсов.
  * Возможные аномалии: Отсутствуют.
  * Примечание: Сериализуемость обеспечивает полную изоляцию, но также может привести к более низкой производительности из-за блокировок.

#### Виды аномалий:

* **Грязное чтение (Dirty Read):**
  * Описание: Грязное чтение происходит, когда одна транзакция читает данные, которые были изменены другой транзакцией, но еще не были зафиксированы. Если вторая транзакция откатывается, то изменения не сохраняются, и данные, прочитанные первой транзакцией, оказываются некорректными.
  * Пример: Транзакция A читает значение из базы данных, транзакция B изменяет это значение, но затем откатывается. Если транзакция A использует прочитанное значение до подтверждения транзакции B, то она считает "грязные" данные.
* **Неповторяемое чтение (Non-Repeatable Read):**
  * Описание: Неповторяемое чтение происходит, когда одна транзакция читает данные, затем другая транзакция изменяет или удаляет эти данные, и, при повторном чтении данных первой транзакцией, получаются различные результаты.
  * Пример: Транзакция A читает значение из базы данных, транзакция B изменяет или удаляет это значение, и когда транзакция A повторно читает данные, она видит измененные или удаленные данные.
* **Фантомное чтение (Phantom Read):**
  * Описание: Фантомное чтение происходит, когда одна транзакция выполняет запрос по некоторому условию, затем другая транзакция вставляет или удаляет строки, соответствующие этому условию, и первая транзакция при повторном выполнении запроса видит измененное количество строк.
  * Пример: Транзакция A выполняет запрос "SELECT * FROM Orders WHERE Status='Processing'", затем транзакция B добавляет новый заказ с тем же статусом 'Processing'. Если транзакция A повторно выполняет свой запрос, она "увидит" новую строку, которая не существовала в ее первом запросе.